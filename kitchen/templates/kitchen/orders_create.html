{% extends "kitchen/dashboard_base.html" %}

{% load static %}

{% block content %}

<h3>New Order</h3>

<form id="create-order-form" class="card" method="post">
    <div class="form-group">
        <label>Party</label>
        <select name="party" class="form-control">
            <option value="0">New Party</option>
        </select>
    </div>

    <div class="form-group">
        <label>Party Member</label>
        <div class="party-member-container">
            <span id="party-member-list" data-toggle="buttons">
                <label class="btn btn-secondary">
                    <input type="radio" name="party_member" autocomplete="off" /> <span class="party-member-label">1</span>
                </label>
                <label class="btn btn-secondary">
                    <input type="radio" name="party_member" autocomplete="off" /> <span class="party-member-label">2</span>
                </label>
            </span>
            <a id="add-party-member" class="btn btn-outline-success" aria-label="Add new member">+</a>
        </div>
    </div>

    <div class="form-group">
        <label>Choose items</label>
        <div class="order-select-items">
            <ol class="order-select-breadcrumbs btn-group">
            </ol>
            <ul class="menu-select-list">
            </ul>
        </div>
    </div>

    <div class="form-group">
        <input type="submit" class="btn btn-primary" name="submit" value="Submit" />
    </div>
</form>


{% endblock %}

{% block templates %}

<ul class="tpl-menu-select-category">
    <li class="menu-select-category" data-category=""></li>
</ul>

<ul class="tpl-menu-select-item">
    <li class="menu-select-item" data-item=""></li>
</ul>

<ul class="tpl-order-select-breadcrumb">
    <li class="btn btn-secondary"><a></a></li>
</ul>

{% endblock %}

{% block scripts %}

<script>

var api_categories_url = "{% url "menucategory-list" %}";
var api_items_url = "{% url "menuitem-list" %}";

var current_party_index = 2;

function addPartyMember() {
    var elem = $(".party-member-container label").first().clone();
    elem.children(".party-member-label").replaceWith(++current_party_index);

    $("#party-member-list").append(" ");
    elem.appendTo("#party-member-list");
}

function getCategoryList(category_id, container, callback) {
    var data = (category_id > 0) ? {"category": category_id} : {};

    $.get(api_items_url, data, function(data) {
        var menuItems = data.results;
        data = (category_id > 0) ? {"parent": category_id} : {};

        $.get(api_categories_url, data, function(data) {
            var menuCategories = data.results;

            callback(container, menuItems, menuCategories);
        });
    }, "json");
}

function loadMenu(container, menuItems, menuCategories) {
    var catTpl = $(".tpl-menu-select-category li").first().clone();
    var itemTpl = $(".tpl-menu-select-item li").first().clone();

    container.html("");

    menuCategories.forEach(function(category) {
        var currentTpl = catTpl.clone();

        currentTpl.data("category", category.id);
        currentTpl.text(category.name);
        container.append(currentTpl);
    });

    menuItems.forEach(function(item) {
        var currentTpl = itemTpl.clone();

        currentTpl.data("item", item.id);
        currentTpl.text(item.name);
        container.append(currentTpl);
    });
}

function pushCategoryBreadcrumb(container, categoryId, categoryName) {
    var template = $(".tpl-order-select-breadcrumb").children("li").clone();
    console.log("Pushing breadcrumb: " + categoryName);
    template.data("category", categoryId);
    template.children("a").text(categoryName);
    console.log(template.html());
    container.append(template);
}

function popCategoryBreadcrumb(container) {
    container.children().last().remove();
}

function gotoCategoryBreadcrumb(container, categoryId) {
    var found = false;

    while(!found) {
        var elem = container.children().last();

        if (!elem)
            break;

        if (elem.data("category") == categoryId) {
            found = true;
        } else {
            elem.remove();
        }
    }
}

$(function() {
    jqueryAjaxSetup();

    $("#add-party-member").click(addPartyMember);

    // Listen for clicks when categories are selected.
    $(".menu-select-list").on('click', '.menu-select-category', function(e) {
        var elem = $(this);
        var categoryId = elem.data("category");
        var selectList = elem.parent(".menu-select-list");
        var breadcrumbs = selectList.parent(".order-select-items").children(".order-select-breadcrumbs");
        var categoryName = elem.text();

        pushCategoryBreadcrumb(breadcrumbs, categoryId, categoryName);
        getCategoryList(categoryId, selectList, loadMenu);
    });

    $(".order-select-breadcrumbs").on('click', 'li', function(e) {
        var elem = $(this);
        var breadcrumbs = elem.parent(".order-select-breadcrumbs");
        var selectList = breadcrumbs.parent().children(".menu-select-list");
        var categoryId = elem.data("category");

        getCategoryList(categoryId, selectList, loadMenu);
        gotoCategoryBreadcrumb(breadcrumbs, categoryId);
    });

    // Initially load menu inside of all menu-select-list elements.
    getCategoryList(0, $(".menu-select-list"), loadMenu);
    pushCategoryBreadcrumb($(".order-select-breadcrumbs"), 0, "Menu");
});

</script>

{% endblock %}

